<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Projeção de Banca</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <style>
      :root {
        --primary: #4361ee;
        --primary-light: #4895ef;
        --primary-dark: #3f37c9;
        --success: #4cc9f0;
        --success-light: #d4edda;
        --warning: #f8961e;
        --danger: #f94144;
        --light: #f8f9fa;
        --dark: #212529;
        --gray-100: #f8f9fa;
        --gray-200: #e9ecef;
        --gray-300: #dee2e6;
        --gray-400: #ced4da;
        --gray-500: #adb5bd;
        --gray-600: #6c757d;
        --gray-700: #495057;
        --gray-800: #343a40;
        --gray-900: #212529;
        --border-radius: 0.5rem;
        --box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
        --transition: all 0.2s ease-in-out;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--gray-100);
        color: var(--gray-800);
        line-height: 1.5;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem 1rem;
        min-height: 100vh;
      }

      .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
      }

      h2 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .card {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: var(--transition);
      }

      .card:hover {
        box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1);
      }

      .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      @media (min-width: 769px) {
        .input-grid {
          grid-template-columns: repeat(3, 1fr);
        }

        .input-group.larger-field {
          grid-column: span 1;
        }

        .input-group:nth-child(1),
        .input-group:nth-child(2),
        .input-group:nth-child(3) {
          grid-column: span 1;
        }

        .input-group:nth-child(4),
        .input-group:nth-child(5),
        .input-group:nth-child(6) {
          grid-column: span 1;
        }

        .input-group:nth-child(7),
        .input-group:nth-child(8),
        .input-group:nth-child(9),
        .input-group:nth-child(10),
        .input-group:nth-child(11) {
          grid-column: span 1;
        }
      }

      .input-group {
        display: flex;
        flex-direction: column;
      }

      .input-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--gray-700);
        font-size: 0.875rem;
      }

      .input-group input,
      .input-group select {
        padding: 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        font-size: 0.875rem;
        transition: var(--transition);
        color: var(--gray-800);
        background-color: white;
      }

      .input-group input:focus,
      .input-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--gray-200);
      }

      .info-item {
        display: flex;
        flex-direction: column;
      }

      .info-item .label {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--gray-600);
        margin-bottom: 0.25rem;
      }

      .info-item .value {
        font-weight: 700;
        font-size: 1.125rem;
        color: var(--gray-900);
      }

      .table-card {
        overflow: hidden;
        margin-bottom: 2rem;
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background-color: var(--gray-100);
        border-bottom: 1px solid var(--gray-200);
      }

      .table-title {
        font-weight: 600;
        font-size: 1rem;
        color: var(--gray-800);
      }

      .export-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: var(--transition);
      }

      .export-btn:hover {
        background-color: var(--primary-dark);
      }

      .table-container {
        overflow-x: auto;
        max-height: 500px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background-color: var(--gray-100);
        color: var(--gray-700);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--gray-300);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--gray-200);
        font-size: 0.875rem;
        color: var(--gray-800);
      }

      tr:hover td {
        background-color: var(--gray-50);
      }

      tr.green-row {
        background-color: rgba(76, 201, 240, 0.1) !important;
      }

      tr.green-row td {
        font-weight: 600;
        color: var(--primary-dark);
      }

      tr.current-day-row td {
        background-color: rgba(67, 97, 238, 0.1) !important;
      }

      tr.passed-day-row td {
        color: var(--gray-600);
        background-color: var(--gray-50);
      }

      tr.last-passed-day-row td {
        background-color: white !important;
        font-weight: normal;
      }

      .info-item.period-info {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Projeção de Banca</h2>

      <div class="card">
        <div class="input-grid">
          <div class="input-group">
            <label for="bankInput">Banca inicial (US$)</label>
            <input type="number" id="bankInput" value="3" />
          </div>
          <div class="input-group">
            <label for="daysInput">Dias</label>
            <input type="number" id="daysInput" value="205" />
          </div>
          <div class="input-group">
            <label for="operationsInput">Operações</label>
            <input type="number" id="operationsInput" value="1" />
          </div>
          <div class="input-group">
            <label for="ticksInput">Ticks por operação</label>
            <input type="number" id="ticksInput" value="200" />
          </div>
          <div class="input-group">
            <label for="targetInput">Meta (US$)</label>
            <input type="number" id="targetInput" value="200000.00" />
          </div>
          <div class="input-group larger-field">
            <label for="recalculateDaysInput">Recalcular a cada (dias)</label>
            <input type="number" id="recalculateDaysInput" value="10" min="1" />
          </div>

          <div class="input-group">
            <label for="accountType">Tipo de Conta</label>
            <select name="accountType" id="accountType">
              <option value="mt5_mini_real_vc">Standard</option>
              <option value="mt5_raw_real_vc">Raw Spread</option>
              <option value="mt5_zero_real_vc" selected>Zero</option>
              <option value="mt5_classic_real_vc">Pro</option>
              <option value="mt5_cent_real_vc">Standard Cent</option>
            </select>
          </div>

          <div class="input-group">
            <label for="accountCurrency">Moeda da Conta</label>
            <select name="accountCurrency" id="accountCurrency">
              <option value="USD" selected>USD</option>
              <!-- Add other currency options here if needed -->
            </select>
          </div>

          <div class="input-group">
            <label for="instrument">Instrumento</label>
            <select name="instrument" id="instrument">
              <option value="XAUUSD" selected>XAUUSD</option>
              <option value="BTCUSD">BTCUSD</option>
              <!-- Add other instrument options here if needed -->
            </select>
          </div>

          <div class="input-group">
            <label for="lot">Lote</label>
            <input type="number" id="lot" value="0.01" step="0.01" />
          </div>

          <div class="input-group">
            <label for="leverage">Alavancagem</label>
            <select name="leverage" id="leverage">
              <option value="2000" selected>1:2000</option>
              <!-- Add other leverage options here if needed -->
            </select>
          </div>

          <div class="input-group larger-field">
            <label for="marginInput">Margem de 0.01 lote</label>
            <input type="number" id="marginInput" value="" step="0.01" readonly/>
          </div>
        </div>

        <div class="info-grid">
          <div class="info-item period-info" style="display: none;">
            <span class="label">Período</span>
            <span class="value">10/03/2025 até 19/12/2025</span>
          </div>
          <div class="info-item">
            <span class="label">Banca Final</span>
            <span class="value" id="finalBankValue">$0.00</span>
          </div>
          <div class="info-item">
            <span class="label">% de Lucro Diário</span>
            <span class="value" id="dailyProfitPercentage">0%</span>
          </div>
          <div class="info-item">
            <span class="label">Meta batida com</span>
            <span class="value" id="targetAchievedDay">0 dias</span>
          </div>
          <div class="info-item">
            <span class="label">Dias operados</span>
            <span class="value" id="daysOperated">0 dias</span>
          </div>
        </div>
      </div>

      <div class="card table-card">
        <div class="table-header">
          <h3 class="table-title">Projeção Diária</h3>
          <button id="card-table-button" class="export-btn" onclick="exportToPDF()">
            Exportar para PDF
          </button>
        </div>
        <div class="table-container" id="projectionTableWrapper">
          <table id="projectionTable">
            <thead>
              <tr>
                <th>Dia</th>
                <th>Data</th>
                <th>Banca Inicial</th>
                <th>Lucro do Dia</th>
                <th>Lucro por Operação</th>
                <th>Banca Total</th>
                <th>Meta %</th>
                <th>Lote</th>
                <th>Operações</th>
                <th>Ticks</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const targetInputElement = document.getElementById("targetInput");
      const marginInput = document.querySelector("#marginInput");
      const ticksInput = document.querySelector("#ticksInput");
      const lotInput = document.querySelector("#lot");
      const accountTypeSelect = document.querySelector("#accountType");
      const accountCurrencySelect = document.querySelector("#accountCurrency");
      const instrumentSelect = document.querySelector("#instrument");
      const leverageSelect = document.querySelector("#leverage");
      const daysInput = document.querySelector("#daysInput");
      const operationsInput = document.querySelector("#operationsInput");
      const bankInput = document.querySelector("#bankInput");
      const targetInput = document.querySelector("#targetInput");
      const recalculateDaysInput = document.querySelector("#recalculateDaysInput");
      let averageDolar = 0;
      let defaultMarginValue = 1.49;

      function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const initialBank = parseFloat(bankInput.value);
        const days = parseInt(daysInput.value);
        const operationsPerDay = parseInt(operationsInput.value);
        const ticksPerOperation = parseInt(ticksInput.value);
        const targetValue = parseFloat(targetInput.value);
        const recalculateDays = parseInt(recalculateDaysInput.value);

        const accountType = accountTypeSelect.value;
        const accountCurrency = accountCurrencySelect.value;
        const instrument = instrumentSelect.value;
        const lot = parseFloat(lotInput.value);
        const leverage = leverageSelect.value;
        const finalBank = document.querySelector("#finalBankValue").textContent;
        const targetDay = parseInt(document.querySelector("#targetAchievedDay").textContent);
        const marginValue = parseFloat(marginInput.value);

        doc.setFontSize(10);
        doc.text(`Banca inicial ${initialBank.toFixed(2)}`, 10, 10);
        doc.text(`Dias ${days}`, 10, 20);
        doc.text(`Operações por dia ${operationsPerDay}`, 10, 30);
        doc.text(`Ticks por operação ${ticksPerOperation}`, 10, 40);
        doc.text(`Meta ${targetValue.toFixed(2)}`, 10, 50);
        doc.text(`Tipo de Conta ${accountType}`, 10, 60);
        doc.text(`Moeda da Conta ${accountCurrency}`, 10, 70);
        doc.text(`Instrumento ${instrument}`, 10, 80);
        doc.text(`Lote ${lot}`, 10, 90);
        doc.text(`Alavancagem ${leverage}`, 10, 100);
        doc.text(`Valor de 0.01 lote ${marginValue.toFixed(2)}`, 10, 110);
        doc.text(`Recalcular a cada ${recalculateDays} dias`, 10, 120);
        doc.text(`Meta atingida em ${targetDay} dias de operação`, 10, 130);
        doc.text(`Banca final ${finalBank}`, 10, 140);

        doc.autoTable({
          html: "#projectionTable",
          startY: 150,
          styles: { fontSize: 8 },
        });

        doc.save("projection.pdf");
      }

      async function fetchMargin(instrument, accountType) {
        try {
          const response = await fetch("https://www.exness.com/pwapi/", {
            method: "POST",
            headers: {
              accept: "*/*",
              "accept-language": "pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7",
              baggage:
                "sentry-environment=production,sentry-release=f47772dde3e5b9cb692f019ee3631e33fa7a5471,sentry-public_key=5e0bf93d66884099adcb6f3315fbb49a,sentry-trace_id=1481e3c64b80458e971e689d8ba894bd",
              "content-type": "application/json",
              "sec-ch-ua":
                '"Chromium";v="134", "Not:A-Brand";v="24", "Google Chrome";v="134"',
              "sec-ch-ua-mobile": "?0",
              "sec-ch-ua-platform": '"macOS"',
              "sec-fetch-dest": "empty",
              "sec-fetch-mode": "cors",
              "sec-fetch-site": "same-origin",
              "sentry-trace": "1481e3c64b80458e971e689d8ba894bd-b73156e174f3b681",
              "user-agent":
                "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36",
              origin: "https://www.exness.com",
              referer: "https://www.exness.com/pt/calculator/",
            },
            body: JSON.stringify({
              operationName: "Calculate",
              variables: {
                input: {
                  account_type: accountType,
                  instrument: instrument,
                  currency: "USD",
                  leverage: 2000,
                  lot: 0.01,
                },
              },
              query:
                "mutation Calculate($input: CalculationInput!) {  calculate(input: $input) {    currency    margin    pip_value    swap_long    swap_short    spread    commission    __typename  }}",
            }),
          });

          if (!response.ok) {
            console.error(`HTTP error! status: ${response.status}`);
            return null;
          }

          const data = await response.json();

          if (data && data.data && data.data.calculate) {
            return parseFloat(data.data.calculate.margin).toFixed(2);
          } else {
            console.error("Unexpected API response:", data);
            return null;
          }
        } catch (error) {
          console.error("Error fetching margin:", error);
          return null;
        }
      }

      async function generateProjection() {
        const initialBank = parseFloat(bankInput.value);
        const days = parseInt(daysInput.value);
        const operationsPerDay = parseInt(operationsInput.value);
        const ticksPerOperation = parseInt(ticksInput.value);
        const targetValue = parseFloat(targetInput.value);
        const recalculateDays = parseInt(recalculateDaysInput.value);

        const accountType = accountTypeSelect.value;
        const accountCurrency = accountCurrencySelect.value;
        const instrument = instrumentSelect.value;
        const lot = parseFloat(lotInput.value);
        const leverage = leverageSelect.value;

        const marginValue = parseFloat(marginInput.value);
        const tickValue = instrument === "XAUUSD" ? 0.1 : 0.01;

        let bank = initialBank;
        const maxLotValue = 200;  // Assuming this value remains fixed

        let lotValue = Math.floor(bank / marginValue) * 0.01;
        if (lotValue > maxLotValue) {
            lotValue = maxLotValue;
        }

        let dailyPercentage = ((operationsPerDay * ticksPerOperation * tickValue * lotValue) / bank) * 100;
        let dailyPercentage2 = dailyPercentage.toFixed(2);
        document.querySelector("#dailyProfitPercentage").textContent = dailyPercentage2 + "%";

        const tableBody = document.querySelector("#projectionTable tbody");
        tableBody.innerHTML = "";

        let greenRowAdded = false;
        let targetAchievedDay = null;

        const startDate = new Date("2025-04-21T00:00:00");
        const endDate = new Date("2025-12-19T00:00:00");
        let dayCounter = 1;
        let today = new Date();
        let lastPassedDay = null;
        let daysWithCheckmark = 0;
        let currentDate = new Date(startDate);

        while (currentDate <= endDate && dayCounter <= days) {
            const dayOfWeek = currentDate.getDay();
            if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                const dailyProfit = operationsPerDay * ticksPerOperation * tickValue * lotValue;
                bank += dailyProfit;

                const row = document.createElement("tr");

                if (!greenRowAdded && bank >= targetValue) {
                    row.classList.add("green-row");
                    greenRowAdded = true;
                    targetAchievedDay = dayCounter;
                }

                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, "0");
                    const day = String(date.getDate()).padStart(2, "0");
                    return `${day}/${month}/${year}`;
                };

                if (formatDate(currentDate) === formatDate(today) && !greenRowAdded) {
                    row.classList.add("current-day-row");
                }

                if (currentDate < today) {
                    row.classList.add("passed-day-row");
                    lastPassedDay = { row: row, day: dayCounter };
                    daysWithCheckmark++;
                }

                const formattedDate = formatDate(currentDate);

                let dayDisplay = dayCounter;

                const profitPerOperation = operationsPerDay > 0 ? (dailyProfit / operationsPerDay).toFixed(2) : "0.00";

                row.innerHTML = `
                    <td>${dayDisplay}</td>
                    <td>${formattedDate}</td>
                    <td>${(bank - dailyProfit).toFixed(2)}</td>
                    <td>${dailyProfit.toFixed(2)}</td>
                    <td>${profitPerOperation}</td>
                    <td>${bank.toFixed(2)}</td>
                    <td>${dailyPercentage.toFixed(2)}%</td>
                    <td>${lotValue.toFixed(2)}</td>
                    <td>${operationsPerDay}</td>
                    <td>${ticksPerOperation}</td>
                `;

                tableBody.appendChild(row);
                dayCounter++;
            }
            currentDate.setDate(currentDate.getDate() + 1);

            if (dayCounter % recalculateDays === 1 && dayCounter !== 1) {
                if (lotValue < maxLotValue) {
                    lotValue = Math.min(
                        maxLotValue,
                        Math.floor(bank / marginValue) * 0.01
                    );
                }
            }
        }

        if (lastPassedDay) {
            lastPassedDay.row.classList.remove("passed-day-row");
            lastPassedDay.row.classList.add("last-passed-day-row");
            lastPassedDay.row.querySelector("td:first-child").textContent = lastPassedDay.day;
        }

        const formattedBankValue = new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
        }).format(bank);
        document.querySelector("#finalBankValue").textContent = formattedBankValue;
        document.querySelector("#targetAchievedDay").textContent = targetAchievedDay ? targetAchievedDay + " dias de operação" : "Meta não atingida";
        document.querySelector("#daysOperated").textContent = daysWithCheckmark - 1 + " dias";
      }

      async function fetchDollarRate() {
        try {
          const response = await fetch(
            "https://economia.awesomeapi.com.br/json/last/USD-BRL"
          );
          const data = await response.json();
          usdToBrlCreateDate = data.USDBRL.create_date;
          const high = parseFloat(data.USDBRL.high);
          const low = parseFloat(data.USDBRL.low);
          const average = ((high + low) / 2).toFixed(2);
          averageDolar = 1000000 / average;
          document.querySelector("#targetInput").value = averageDolar.toFixed(
            2
          );
        } catch (error) {
          console.error("Erro ao buscar a cotação do dólar:", error);
        }
      }

      async function updateMargin() {
          const accountType = accountTypeSelect.value;
          const instrument = instrumentSelect.value;

          const margin = await fetchMargin(instrument, accountType);
          marginInput.value = margin !== null ? margin : parseFloat(defaultMarginValue).toFixed(2);

          generateProjection();
      }

      accountTypeSelect.addEventListener("change", updateMargin);
      accountCurrencySelect.addEventListener("change", updateMargin);
      instrumentSelect.addEventListener("change", () => {
        if (instrumentSelect.value === "XAUUSD") {
            ticksInput.value = 200;
        } else if (instrumentSelect.value === "BTCUSD") {
            ticksInput.value = 5000;
        }
        updateMargin()
      });
      lotInput.addEventListener("change", updateMargin)

      bankInput.addEventListener("input", generateProjection);
      daysInput.addEventListener("input", generateProjection);
      operationsInput.addEventListener("input", generateProjection);
      ticksInput.addEventListener("input", generateProjection);
      targetInput.addEventListener("input", generateProjection);
      recalculateDaysInput.addEventListener("input", generateProjection);

      let usdToBrlCreateDate;

      async function initialize() {
        await fetchDollarRate();
        await updateMargin();  // Fetch initial margin value
      }

      initialize();
    </script>
  </body>
</html>
